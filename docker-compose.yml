services:
  postgres:
    image: pgvector/pgvector:pg16
    environment:
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: ${DB_NAME}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER} -d ${DB_NAME}"]
      interval: 5s
      timeout: 5s
      retries: 10

  backend:
    build:
      context: ./apps/backend
    environment:
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_NAME: ${DB_NAME}
      FRONTEND_ORIGIN: ${FRONTEND_ORIGIN}
      RERANK_MAX_ROWS_TRAIN: ${RERANK_MAX_ROWS_TRAIN}
      RERANK_MAX_ROWS_DEV: ${RERANK_MAX_ROWS_DEV}
      RERANK_NEG_PER_POS: ${RERANK_NEG_PER_POS}
      RERANK_NEG_HASH_PCT: ${RERANK_NEG_HASH_PCT}
      RERANK_SPLITS: ${RERANK_SPLITS}
      RERANKER_MODEL_PATH: ${RERANKER_MODEL_PATH}
      RERANKER_CONFIG_PATH: ${RERANKER_CONFIG_PATH}
      SMTP_HOST: ${SMTP_HOST}
      SMTP_PORT: ${SMTP_PORT}
      SMTP_USER: ${SMTP_USER}
      SMTP_PASSWORD: ${SMTP_PASSWORD}
      SMTP_FROM: ${SMTP_FROM}
      SMTP_TLS: ${SMTP_TLS}
    volumes:
      - ./ml:/app/ml
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - "8000:8000"
    command: >
      sh -c "alembic upgrade head && uvicorn app.main:app --host 0.0.0.0 --port 8000"

  frontend:
    build:
      context: ./apps/frontend
    environment:
      VITE_API_BASE: ${VITE_API_BASE}
    depends_on:
      - backend
    ports:
      - "5173:5173"
    command: >
      sh -c "npm install && npm run dev -- --host 0.0.0.0 --port 5173"

  prometheus:
    image: prom/prometheus:v2.55.1
    volumes:
      - ./infra/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    ports:
      - "9090:9090"
    depends_on:
      - backend

  cron:
    build:
      context: ./apps/backend
    volumes:
      - ./ml:/app/ml
    depends_on:
      - backend
    environment:
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_NAME: ${DB_NAME}
      EMB_MODEL_NAME: ${EMB_MODEL_NAME}
      EMB_BATCH_SIZE: ${EMB_BATCH_SIZE}
      EMB_FETCH_BATCH: ${EMB_FETCH_BATCH}
    command: >
      sh -c "apt-get update && apt-get install -y --no-install-recommends cron && rm -rf /var/lib/apt/lists/* &&
      echo '*/10 * * * * python /app/ml/scripts/fetch_fresh_rss.py --hours 168 && python /app/ml/scripts/ingest_fresh_to_postgres.py --input /tmp/fresh_items.json' > /etc/cron.d/topfeed &&
      echo '5 * * * * python /app/ml/scripts/update_top_incremental.py --hours 1' >> /etc/cron.d/topfeed &&
      chmod 0644 /etc/cron.d/topfeed &&
      crontab /etc/cron.d/topfeed &&
      cron -f -L 15"

volumes:
  postgres_data:
